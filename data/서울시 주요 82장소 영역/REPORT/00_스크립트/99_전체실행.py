# -*- coding: utf-8 -*-
"""
ì˜ì›ê¸‰ í”¼ë¶€ê³¼ ì…ì§€ ë¶„ì„ - ì „ì²´ íŒŒì´í”„ë¼ì¸ í†µí•© ì‹¤í–‰
ì‘ì„±ì¼: 2026-02-03
ë²„ì „: 1.0
ì„¤ëª…: ë°ì´í„° ë¡œë”©ë¶€í„° ìµœì¢… ë³´ê³ ì„œ ìƒì„±ê¹Œì§€ ì „ì²´ ë¶„ì„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
"""

import sys
import os
import subprocess
from datetime import datetime
import time

# í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ê²½ë¡œì— ì¶”ê°€
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

print("=" * 80)
print("ğŸ¥ ì˜ì›ê¸‰ í”¼ë¶€ê³¼ ì…ì§€ ë¶„ì„ - ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰")
print("=" * 80)
print(f"ì‹œì‘ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print("=" * 80)

# ì „ì²´ ì‹œì‘ ì‹œê°„ ê¸°ë¡
total_start_time = time.time()

# ============================================================================
# ì‚¬ì „ ë‹¨ê³„: í™˜ê²½ ì§„ë‹¨
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸ” [ì‚¬ì „ ë‹¨ê³„] í™˜ê²½ ì§„ë‹¨")
print("â–¶" * 40)

step_start = time.time()
try:
    import subprocess
    result = subprocess.run(
        [sys.executable, os.path.join(current_dir, '00_í™˜ê²½ì§„ë‹¨.py')],
        capture_output=True,
        text=True,
        timeout=30,
        encoding='utf-8'
    )
    
    if result.returncode == 0:
        print(result.stdout)
        step_elapsed = time.time() - step_start
        print(f"\nâœ… í™˜ê²½ ì§„ë‹¨ ì™„ë£Œ (ì†Œìš” ì‹œê°„: {step_elapsed:.1f}ì´ˆ)", flush=True)
    else:
        print(result.stdout)
        print(result.stderr)
        print(f"\nâŒ í™˜ê²½ ì§„ë‹¨ ì‹¤íŒ¨! ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)
        sys.exit(1)
        
except subprocess.TimeoutExpired:
    print(f"\nâš  í™˜ê²½ ì§„ë‹¨ íƒ€ì„ì•„ì›ƒ (30ì´ˆ ì´ˆê³¼)", flush=True)
    print("í™˜ê²½ ì§„ë‹¨ì„ ê±´ë„ˆë›°ê³  ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...", flush=True)
except Exception as e:
    print(f"\nâš  í™˜ê²½ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}", flush=True)
    print("í™˜ê²½ ì§„ë‹¨ì„ ê±´ë„ˆë›°ê³  ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...", flush=True)

# ============================================================================
# ë‹¨ê³„ 1: ë°ì´í„° ë¡œë”© ë° ì¤€ë¹„
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸ“‚ [ë‹¨ê³„ 1/6] ë°ì´í„° ë¡œë”© ë° ì¤€ë¹„")
print("â–¶" * 40)

step_start = time.time()
STEP1_TIMEOUT = 180  # 3ë¶„ íƒ€ì„ì•„ì›ƒ

try:
    # íƒ€ì„ì•„ì›ƒì„ ìœ„í•œ ë³„ë„ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
    import subprocess
    
    print("ë°ì´í„° ë¡œë”© ì¤‘... (ìµœëŒ€ ëŒ€ê¸° ì‹œê°„: 180ì´ˆ)", flush=True)
    result = subprocess.run(
        [sys.executable, '-c', 
         'import sys; sys.path.insert(0, r"' + current_dir + '"); '
         'from ë°ì´í„°ë¡œë”© import load_data; '
         'dataframes, output_base = load_data(); '
         'print("LOAD_SUCCESS")'],
        capture_output=True,
        text=True,
        timeout=STEP1_TIMEOUT,
        encoding='utf-8',
        cwd=current_dir
    )
    
    if "LOAD_SUCCESS" in result.stdout:
        print(result.stdout)
        # ì‹¤ì œ ë°ì´í„° ë¡œë”© (ì´ë¯¸ ê²€ì¦ë¨)
        from ë°ì´í„°ë¡œë”© import load_data
        dataframes, output_base = load_data()
        
        step_elapsed = time.time() - step_start
        print(f"\nâœ… ë‹¨ê³„ 1 ì™„ë£Œ (ì†Œìš” ì‹œê°„: {step_elapsed:.1f}ì´ˆ)", flush=True)
    else:
        print(result.stdout)
        print(result.stderr)
        raise Exception("ë°ì´í„° ë¡œë”© ê²€ì¦ ì‹¤íŒ¨")
        
except subprocess.TimeoutExpired:
    print(f"\nâŒ ë‹¨ê³„ 1 íƒ€ì„ì•„ì›ƒ ({STEP1_TIMEOUT}ì´ˆ ì´ˆê³¼)", flush=True)
    print("ì˜¤ë¥˜ ì§„ë‹¨:", flush=True)
    print("  1. heartbeat.txt íŒŒì¼ì„ í™•ì¸í•˜ì—¬ ì–´ëŠ ë‹¨ê³„ì—ì„œ ë©ˆì·„ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.", flush=True)
    print("  2. ë©”ëª¨ë¦¬ ë¶€ì¡± ê°€ëŠ¥ì„±: ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ê³  ì¬ì‹œë„í•˜ì„¸ìš”.", flush=True)
    print("  3. ë°ì´í„° íŒŒì¼ ì†ìƒ ê°€ëŠ¥ì„±: 00_í™˜ê²½ì§„ë‹¨.pyë¥¼ ì‹¤í–‰í•˜ì—¬ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.", flush=True)
    sys.exit(1)
except Exception as e:
    print(f"\nâŒ ë‹¨ê³„ 1 ì‹¤íŒ¨: {e}", flush=True)
    print("ì˜¤ë¥˜ ìƒì„¸:", flush=True)
    import traceback
    traceback.print_exc()
    
    # ë³µêµ¬ ì˜µì…˜ ì œì‹œ
    print("\nğŸ’¡ ë³µêµ¬ ì˜µì…˜:", flush=True)
    print("  1. 01_ë°ì´í„°ë¡œë”©.pyë¥¼ ë‹¨ë…ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸", flush=True)
    print("  2. heartbeat.txt íŒŒì¼ì„ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì§€ì  íŒŒì•…", flush=True)
    print("  3. í™˜ê²½ì§„ë‹¨_ê²°ê³¼.txt íŒŒì¼ì„ í™•ì¸í•˜ì—¬ í™˜ê²½ ë¬¸ì œ í™•ì¸", flush=True)
    sys.exit(1)


# ============================================================================
# ë‹¨ê³„ 2: ê²½ìŸ í™˜ê²½ ë¶„ì„
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸª [ë‹¨ê³„ 2/6] ê²½ìŸ í™˜ê²½ ë¶„ì„")
print("â–¶" * 40)
print("âš  ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ëª¨ë“ˆì…ë‹ˆë‹¤.", flush=True)
print("â†’ 02_ê²½ìŸí™˜ê²½ë¶„ì„.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)

# step_start = time.time()
# try:
#     from ê²½ìŸí™˜ê²½ë¶„ì„ import analyze_competition
#     analyze_competition(dataframes, output_base)
#     step_elapsed = time.time() - step_start
#     print(f"\nâœ… ë‹¨ê³„ 2 ì™„ë£Œ (ì†Œìš” ì‹œê°„: {step_elapsed:.1f}ì´ˆ)", flush=True)
# except Exception as e:
#     print(f"\nâŒ ë‹¨ê³„ 2 ì‹¤íŒ¨: {e}", flush=True)
#     sys.exit(1)

# ============================================================================
# ë‹¨ê³„ 3: ê³ ê° ë° ë§¤ì¶œ ë¶„ì„
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸ‘¥ [ë‹¨ê³„ 3/6] ê³ ê° ë° ë§¤ì¶œ ë¶„ì„")
print("â–¶" * 40)
print("âš  ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ëª¨ë“ˆì…ë‹ˆë‹¤.", flush=True)
print("â†’ 03_ê³ ê°ë¶„ì„.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)

# ============================================================================
# ë‹¨ê³„ 4: ì¸êµ¬ ë° ìœ ë™ëŸ‰ ë¶„ì„
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸš¶ [ë‹¨ê³„ 4/6] ì¸êµ¬ ë° ìœ ë™ëŸ‰ ë¶„ì„")
print("â–¶" * 40)
print("âš  ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ëª¨ë“ˆì…ë‹ˆë‹¤.", flush=True)
print("â†’ 04_ì¸êµ¬ìœ ë™ë¶„ì„.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)

# ============================================================================
# ë‹¨ê³„ 5: ì…ì§€ ë° ì¸í”„ë¼ í‰ê°€
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸ“ [ë‹¨ê³„ 5/6] ì…ì§€ ë° ì¸í”„ë¼ í‰ê°€")
print("â–¶" * 40)
print("âš  ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ëª¨ë“ˆì…ë‹ˆë‹¤.", flush=True)
print("â†’ 05_ì…ì§€ì¡°ê±´ë¶„ì„.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)

# ============================================================================
# ë‹¨ê³„ 6: ì¢…í•© í‰ê°€ ë° ë³´ê³ ì„œ ìƒì„±
# ============================================================================
print("\n" + "â–¶" * 40)
print("ğŸ“Š [ë‹¨ê³„ 6/6] ì¢…í•© í‰ê°€ ë° ë³´ê³ ì„œ ìƒì„±")
print("â–¶" * 40)
print("âš  ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ëª¨ë“ˆì…ë‹ˆë‹¤.", flush=True)
print("â†’ 06_ì¢…í•©í‰ê°€.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.", flush=True)

# ============================================================================
# ì „ì²´ ì‹¤í–‰ ì™„ë£Œ
# ============================================================================
total_elapsed = time.time() - total_start_time
print("\n" + "=" * 80)
print("ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ!")
print("=" * 80)
print(f"ì´ ì†Œìš” ì‹œê°„: {total_elapsed:.1f}ì´ˆ ({total_elapsed/60:.1f}ë¶„)")
print(f"ì¢…ë£Œ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print(f"ì‚°ì¶œë¬¼ ì €ì¥ ê²½ë¡œ: {output_base}")
print("=" * 80)
print("\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:")
print("  1. REPORT/ ë””ë ‰í† ë¦¬ì˜ ê° í´ë”ì—ì„œ ìƒì„±ëœ CSV ë° PNG íŒŒì¼ í™•ì¸")
print("  2. 06_ìµœì¢…ë¦¬í¬íŠ¸/ í´ë”ì˜ ì¢…í•© ë³´ê³ ì„œ ê²€í† ")
print("  3. ì¶”ì²œ ìƒê¶Œ Top 3 ê¸°ë°˜ìœ¼ë¡œ í˜„ì¥ ì‹¤ì‚¬ ê³„íš ìˆ˜ë¦½")
print()
